name: CI
# perms block here, but it might only apply to the ci portion
permissions:
  contents: read
  security-events: write
on:
  push:
    branches: [master, main]
  pull_request:
    # im pretty good at forgetting which branch i used, specifically which tool i made it with (gh and GitHub desktop usually main, vs and git cli usually master)
    branches: [master, main]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: üöß Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: |
         npm install
         sleep 2
         npm ci
      - name: Create dummy freetube files
        run: |
          mkdir -p ./dummy-ft
          # copy the dummy files from the test directory
          # this is to ensure that the export script doesn't fail due to missing files
          cp .github/test/*.db ./dummy-ft/
          mkdir -p ./exports
          # assurance
          for f in history.db playlists.db profiles.db; do
          test -f dummy-ft/$f || (echo "‚ùå Missing dummy-ft/$f" && exit 1)
          done
          sleep 1
      - name: Run Invidious sync and setup webserver
        env:
          MOCK_PORT: 9999
          INSTANCE: http://127.0.0.1:9999
          # i fell asleep on the keyboard to get this token, but it technically works with my "sanitation" (the = and 40ish chars is all you need)
          TOKEN: abnghjksdhghjukzdbghjkasdbgjkhasdbgukhjasdbgkhjasdbghjadsb=
          EXPORT_DIR: ./exports
          FREETUBE_DIR: ./dummy-ft
          VERBOSE: true
          INSECURE: true
          DONT_RUN_SETUP: true
          LOGS: true
        run: |
          node .github/test/mock-invidious.js &
          MOCK_PID=$!
          sleep 2
          node ./src/export.js
          kill $MOCK_PID
          sleep 1
          # give time to finish
      - name: Upload logs
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: ft-to-inv-logs
          path: |
            ft-to-inv-*.log
            ci-output.log
  scan:
   runs-on: ubuntu-latest
   env:
    # have perms at the top of file, but they likely dont apply here
     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
   steps:
    - name: üöß Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Run ESLint
      run: |
        npm install
        npx eslint . --ext .js,.mjs,.cjs,.ts || true

    - name: Run Semgrep
      uses: docker://semgrep/semgrep
      with:
        args: semgrep --config=auto --sarif --output=./semgrep.sarif ./

    - name: List files after Semgrep
    # debug, can prob delete
      run: ls -lh ./

    - name: Upload Semgrep results
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: ./semgrep.sarif

    - name: Run Gitleaks
    # id imagine this fails
      uses: zricethezav/gitleaks-action@v2
      with:
       args: detect --redact --exit-code 1 --report-format sarif --report-path gitleaks-results.sarif

    - name: Run npm audit
    # found this command online, it seems to work ok, but idk what the || true does
      run: npm audit --production --audit-level=moderate || true